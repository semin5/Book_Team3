<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ë¨¸ë¬¼ê³³</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
<script th:inline="javascript">
    const memberId = [[${currentUserId}]];
</script>
<div class="container">
    <div id="notification-box" class="my-3"></div>
    <nav class="navbar navbar-light bg-light">
        <a class="navbar-brand fs-1" th:href="@{/posts}">ğŸ“š ë¨¸ë¬¼ê³³</a>
        <div>
            <div th:if="${currentUserId != null}">
                <a th:href="@{/mypage}" class="btn btn-warning me-2">ë§ˆì´í˜ì´ì§€</a>
                <form th:action="@{/logout}" method="post" class="d-inline">
                    <button class="btn btn-danger">ë¡œê·¸ì•„ì›ƒ</button>
                </form>
            </div>
            <div th:if="${currentUserId == null}">
                <a th:href="@{/oauth2/authorization/google}" class="btn btn-primary">ë¡œê·¸ì¸</a>
            </div>
        </div>
    </nav>
</div>
<div class="container">
    <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
        <span th:text="${errorMessage}">ì˜¤ë¥˜ ë©”ì‹œì§€</span>
    </div>

    <div class="d-flex justify-content-between align-items-center">
        <h2 th:text="${post.title}" class="mb-0">ì œëª©</h2>
        <span class="badge fs-5" th:classappend="${post.isSolved} ? 'bg-success' : 'bg-secondary'" th:text="${post.isSolved} ? 'í•´ê²°ë¨' : 'ë¯¸í•´ê²°'">ìƒíƒœ</span>
    </div>
    <br>
    <div class="text-muted  text-end ms-3">
        <span th:text="'ì‘ì„±ì: ' + ${post.nickname}"></span> |
        <span th:text="'ì‘ì„±ì¼: ' + ${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span> |
        <span th:text="'ì¡°íšŒìˆ˜: ' + ${post.viewCnt}"></span>
    </div>

    <hr>

    <div class="mb-5">
        <p th:text="${post.content}" style="min-height: 250px;"></p>
    </div>
    <div th:if="${images != null and !#lists.isEmpty(images)}" class="my-3">
        <div class="row">
            <div class="col-md-4 mb-3" th:each="image : ${images}">
                <img th:src="@{/images/{id}(id=${image.id})}" class="img-fluid rounded" alt="ì²¨ë¶€ ì´ë¯¸ì§€">
            </div>
        </div>
    </div>
    <hr>

    <div th:if="${post.mapInfo != null}" class="mb-4">
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div class="d-flex flex-column justify-content-between" style="height: 200px; flex-grow: 1;">
                <div class="mb-3">
                    <span th:each="tag : ${post.tags}" class="badge bg-info me-1" th:text="${tag}"></span>
                </div>

                <div class="mb-3">
                    <form th:action="@{/posts/{id}/react(id=${post.postId})}" method="post" style="display:inline;">
                        <input type="hidden" name="type" value="LIKE">
                        <button type="submit" class="btn btm-sm btn-outline-primary"
                                th:classappend="${userReaction} == 'LIKE' ? 'active' : ''">
                            ğŸ‘ ì¢‹ì•„ìš” : <span th:text="${likeCount}">0</span>
                        </button>
                    </form>

                    <form th:action="@{/posts/{id}/react(id=${post.postId})}" method="post" style="display:inline;">
                        <input type="hidden" name="type" value="DISLIKE">
                        <button type="submit" class="btn btm-sm btn-outline-danger"
                                th:classappend="${userReaction} == 'DISLIKE' ? 'active' : ''">
                            ğŸ‘ ì‹«ì–´ìš” : <span th:text="${dislikeCount}">0</span>
                        </button>
                    </form>
                </div>
            </div>

            <div style="width: 300px;" class="ms-4">
                <div id="map" class="border rounded mb-2" style="width:100%; height:150px;"></div>
                <p class="mb-0" style="text-align: left;">
                    <strong>ì£¼ì†Œ:</strong> <span th:text="${post.mapInfo.address}"></span>
                </p>
            </div>
        </div>

        <input type="hidden" id="latitude" th:value="${post.mapInfo.latitude}" />
        <input type="hidden" id="longitude" th:value="${post.mapInfo.longitude}" />
    </div>


    <h4>ğŸ“š ëŒ“ê¸€</h4>

    <div th:if="${comments != null and #lists.isEmpty(comments)}" class="text-muted">
        ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
    </div>

    <div th:each="comment : ${comments}" class="border p-3 mb-3 bg-white rounded shadow-sm">

        <div class="d-flex justify-content-between mb-1">
            <div>
                <strong th:text="${comment.member.nickname}">ì‘ì„±ì</strong>
                <small class="text-muted" th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}">ë‚ ì§œ</small>
            </div>

            <div class="text-end text-muted small" th:if="${comment.book != null}">
                <div th:text="'ğŸ“•ì œëª©: ' + ${comment.book.title}">ì±… ì œëª©</div>
                <div th:text="'âœï¸ì €ì: ' + ${comment.book.author}">ì±… ì €ì</div>
            </div>
        </div>

        <div th:text="${comment.content}" class="mb-2"></div>
        <span class="badge bg-success" th:if="${comment.is_selected}">âœ… ì±„íƒëœ ëŒ“ê¸€</span>

        <div th:if="${currentUserId == post.memberId and !post.isSolved and comment.member.memberId != currentUserId}">
            <form th:action="@{/comments/{id}/adopt(id=${comment.commentId})}" method="post" style="display:inline;">
                <input type="hidden" name="postId" th:value="${post.postId}" />
                <button type="submit" class="btn btn-sm btn-outline-success">âœ… ì±„íƒí•˜ê¸°</button>
            </form>
        </div>

        <div th:if="${comment.member.memberId == currentUserId}" class="mt-5">
            <form th:action="@{/comments/{id}/delete(id=${comment.commentId})}" method="post" style="display:inline;">
                <input type="hidden" name="postId" th:value="${post.postId}" />
                <button type="submit" class="btn btn-sm btn-outline-danger mb-2">ì‚­ì œ</button>
            </form>

            <form th:action="@{/comments/{id}/update(id=${comment.commentId})}" method="post">
                <input type="hidden" name="postId" th:value="${post.postId}" />
                <input type="hidden" name="bookId" th:value="${comment.book != null ? comment.book.bookId : ''}" />

                <div class="d-flex align-items-center mb-2">
                    <label class="me-2 mb-0">ëŒ“ê¸€ :</label>
                    <input type="text" name="content" th:value="${comment.content}" class="form-control" style="width: 91%;"required />
                </div>

                <div class="d-flex align-items-center">
                    <label class="me-2 mb-0">ì±… ì œëª© :</label>
                    <input type="text" name="bookTitle" th:value="${comment.book != null ? comment.book.title : ''}" class="form-control me-2" style="width: 34%;" required />

                    <label class="me-2 mb-0">ì±… ì €ì :</label>
                    <input type="text" name="bookAuthor" th:value="${comment.book != null ? comment.book.author : ''}" class="form-control me-2" style="width: 34%;" required />

                    <button type="submit" class="btn btn-sm btn-outline-primary">ìˆ˜ì •</button>
                </div>
            </form>
        </div>
    </div>

    <hr class="my-4">
    <h5>âœï¸ ëŒ“ê¸€ ì‘ì„±</h5>
    <div th:if="${currentUserId != null and !post.isSolved}">
        <form th:action="@{/comments}" method="post" class="mt-3">
            <input type="hidden" name="postId" th:value="${post.postId}" />

            <div class="mb-2">
                <textarea name="content" rows="3" class="form-control" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required style="resize: none;"></textarea>
            </div>

            <div class="d-flex align-items-center">
                <div class="flex-grow-1 d-flex">
                    <input type="text" name="bookTitle" placeholder="ì±… ì œëª©" class="form-control me-2" required>
                    <input type="text" name="bookAuthor" placeholder="ì±… ì €ì" class="form-control" required>
                </div>
                <div class="ms-2">
                    <button type="submit" class="btn btn-success">ë“±ë¡</button>
                </div>
            </div>
        </form>
    </div>

    <div th:if="${currentUserId == null}" class="text-muted mt-2">
        <p>â€» ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a th:href="@{/oauth2/authorization/google}">Google ë¡œê·¸ì¸</a> í•´ì£¼ì„¸ìš”.</p>
    </div>
    <div th:if="${currentUserId != null and post.isSolved}" class="text-muted mt-2">
        âœ… ì±„íƒëœ ëŒ“ê¸€ì´ ìˆì–´ ë” ì´ìƒ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
    </div>

    <div th:if="${currentUserId == post.memberId}" class="mt-3">
        <a th:href="@{/posts/edit/{id}(id=${post.postId})}" class="btn btn-primary me-2">ìˆ˜ì •</a>
        <form th:action="@{/posts/delete/{id}(id=${post.postId})}" method="post" style="display:inline;">
            <input type="hidden" name="_method" value="delete" />
            <button type="submit" class="btn btn-danger" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</button>
        </form>
    </div>

    <br class="mt-3">
</div>
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=46cdb712fcd3d833c77bfb62dcb1b495&autoload=false&libraries=services"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        kakao.maps.load(function () {
            let lat = parseFloat(document.getElementById('latitude').value);
            let lng = parseFloat(document.getElementById('longitude').value);

            if (!isNaN(lat) && !isNaN(lng)) {
                let mapContainer = document.getElementById('map');
                let mapOption = {
                    center: new kakao.maps.LatLng(lat, lng),
                    level: 3
                };
                let map = new kakao.maps.Map(mapContainer, mapOption);

                new kakao.maps.Marker({
                    map: map,
                    position: new kakao.maps.LatLng(lat, lng)
                });
            } else {
                document.getElementById('map').innerHTML = "<p class='text-danger'>ë“±ë¡ëœ ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            }
        });
    });
</script>
<script>
    if (typeof memberId !== 'undefined') {
        const eventSource = new EventSource(`/notifications/connect?memberId=${memberId}`);

        eventSource.onopen = function () {
            console.log("âœ… SSE ì—°ê²° ì„±ê³µ");
        };

        eventSource.addEventListener("notification", function (event) {
            const notification = JSON.parse(event.data);
            console.log("ğŸ”” ìƒˆ ì•Œë¦¼:", notification);

            const box = document.getElementById("notification-box");
            const item = document.createElement("div");
            item.className = "alert alert-info";

            const link = document.createElement("a");
            link.href = `/posts/${notification.postId}`;
            link.className = "text-decoration-none text-dark";
            link.innerText = `[ì•Œë¦¼] ${notification.content}`;

            item.appendChild(link);
            box.prepend(item);
        });

        eventSource.onerror = function (err) {
            console.error("âŒ SSE ì—°ê²° ì˜¤ë¥˜", err);
            eventSource.close();
        };
    }
</script>
</body>
</html>
